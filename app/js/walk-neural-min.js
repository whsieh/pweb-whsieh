function stopAI(){if(ailoop){clearInterval(ailoop);updateKeyState(0);ailoop=null}}function startAI(){if(!ailoop){if(qt_ready&&nn_ready){run()}else{loadDatasets()}}}function run(){ailoop=setInterval(iterate,50)}function iterate(){curState=extractState(body,joint,environment);curAction=chooseAction(curState);updateKeyState(curAction)}function chooseAction(e){var t=[],n=-Infinity;var r=getActionBias(e);var i=encodeState(e);if(i===1044668||i===1044652){return 8}for(var s=0;s<ACTIONS.length;s++){var o=ACTIONS[s];var u=QT_WEIGHT*Q(e,o)+NN_WEIGHT*r[o];if(u>n){t=[o];n=u}else if(u===n){t.push(o)}}return t[floor(t.length*random())]}function getActionBias(e){var t={0:0,1:0,2:0,4:0,6:0,8:0,9:0};var n=NN.predict(stateVector(e));var r=n[0],i=n[1],s=n[2],o=n[3];if(r>ACTIVE_THRESH){t[1]++;t[9]++}if(i>ACTIVE_THRESH){t[2]++;t[6]++}if(s>ACTIVE_THRESH){t[4]++;t[6]++}if(o>ACTIVE_THRESH){t[8]++;t[9]++}return t}function stateVector(e){var t=Array(14),n=0;for(var r in e){t[n]=round(1e3*normalize(e[r],LIM[r]))/1e3;n++}return t}function actionVector(e){var t=[0,0,0,0];for(var n=KEYMASK.length-1;n>=0;n--){var r=KEYMASK[n];if(e>=r){e-=r;t[n]=1}}return t}function normalize(e,t){var n=t[0],r=t[1];if(e<=n){return-1}else if(e>=r){return 1}else{return 2*(e-n)/(r-n)-1}}function extractState(e,t,n){return{lh_ang:roundToTenThousandth(t.l_hip.GetJointAngle()),lh_w:roundToHundredth(t.l_hip.GetJointSpeed()),rh_ang:roundToTenThousandth(t.r_hip.GetJointAngle()),rh_w:roundToHundredth(t.r_hip.GetJointSpeed()),lk_ang:roundToTenThousandth(t.l_knee.GetJointAngle()),lk_w:roundToHundredth(t.l_knee.GetJointSpeed()),rk_ang:roundToTenThousandth(t.r_knee.GetJointAngle()),rk_w:roundToHundredth(t.r_knee.GetJointSpeed()),T_ang:roundToTenThousandth(e.torso.GetAngle()),T_w:roundToHundredth(e.torso.GetAngularVelocity()),LL_c:hasContact(e.ll_leg,n.floor)?1:-1,LR_c:hasContact(e.lr_leg,n.floor)?1:-1,LF_y:roundToTenth(getLeftFootY(e)),RF_y:roundToTenth(getRightFootY(e))}}function loadDatasets(e,t,n){stopAI();e=e||"qtab-400";t=t||"nnet-14_00";n=n||14;$.getJSON("datasets/"+t+".json",function(e){NN=new NeuralNetwork(14,n,4);if(e.length){console.log("- Using dataset: "+t+".json:");console.log("  * Backpropagating "+Object.keys(e).length+" datapoints...");for(var r=0;r<e.length;r++){var i=e[r];NN.update(i[0],actionVector(i[1]))}}else{console.log("- Using weights: "+t+".json:");for(var s=0;s<n;s++){NN.hidden[s].bias=e.hidden[s].bias;NN.hidden[s].weights=e.hidden[s].weights}for(var o=0;o<4;o++){NN.output[o].bias=e.output[o].bias;NN.output[o].weights=e.output[o].weights}}console.log("...Done!");nn_ready=true;if(nn_ready&&qt_ready){run()}});$.getJSON("datasets/"+e+".json",function(t){console.log("- Using dataset: "+e+".json:");_Q=t;console.log("  * Loaded "+Object.keys(_Q).length+" states...");console.log("...Done!");qt_ready=true;if(nn_ready&&qt_ready){run()}})}function initFeatures(){features.push(function(e){var t=.8*(e.lk_ang+.25);return t});features.push(function(e){var t=.8*(e.rk_ang+.25);return t});features.push(function(e){var t=.5*(e.lh_ang+1);return t});features.push(function(e){var t=.5*(e.rh_ang+1);return t});features.push(function(e){var t=.4*(1.25+max(-1.25,min(1.25,e.T_ang)));return t});features.push(function(e){var t=min(max(floor(e.LF_y/20),0),SQRTRES-1);t=t*SQRTRES+min(max(floor(e.RF_y/20),0),SQRTRES-1);return t/RESOLUTION})}function Q(e,t){var n=encodeState(e);if(n in _Q&&t in _Q[n]){return _Q[n][t]}else{return-1}}function encodeState(e){if("code"in e){return e.code}else{var t=0;features.forEach(function(n){var r=discretize(n(e),RESOLUTION);t=RESOLUTION*t+r});e.code=t;return t}}function discretize(e,t,n,r){n=n==undefined?0:n;r=r==undefined?1:r;var i=min(t-1,max(0,floor((e-n)*t)));return i}var ailoop=null;var NN=null;var KEYMASK=[1,2,4,8];var nn_ready=false,qt_ready=false;var NN_WEIGHT=10;var QT_WEIGHT=1;var curState=null;var curAction=0;var _Q=null;var LIM={lh_ang:[-1.1,1.1],lh_w:[-4.6,5.1],rh_ang:[-1.1,1.1],rh_w:[-4.1,4.3],lk_ang:[-.3,1.1],lk_w:[-5.8,4.4],rk_ang:[-.3,1.1],rk_w:[-6,6.2],T_ang:[-2.1,2.1],T_w:[-2.4,2.8],LL_c:[-1,1],LR_c:[-1,1],LF_y:[5,125],RF_y:[5,125]};var ACTIVE_THRESH=.1;var ACTIONS=[0,1,2,4,6,8,9];var features=[];initFeatures();var RESOLUTION=16;var SQRTRES=sqrt(RESOLUTION)