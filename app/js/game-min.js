function createBall(e,t,n,r,i,s){r=20;var o=new b2BodyDef;var u=new b2FixtureDef;u.density=s==undefined?1:s;u.friction=5;u.restitution=.5;o.type=i?b2Body.b2_staticBody:b2Body.b2_dynamicBody;u.shape=new b2CircleShape(r);o.position.x=t;o.position.y=n;e.CreateBody(o).CreateFixture(u);return e.GetBodyList()}function createPolygon(e,t,n,r,i,s){var o=new b2BodyDef;var u=new b2FixtureDef;u.density=s==undefined?1:s;u.friction=15;u.restitution=1;o.type=i?b2Body.b2_staticBody:b2Body.b2_dynamicBody;u.shape=new b2PolygonShape;u.shape.SetAsArray(r.map(function(e){return new b2Vec2(e.x,e.y)}));o.position.x=t;o.position.y=n;e.CreateBody(o).CreateFixture(u);return e.GetBodyList()}function createBox(e,t,n,r,i,s,o,u){if(s==0||s==undefined){vtx=[{x:-r/2,y:-i/2},{x:r/2,y:-i/2},{x:r/2,y:i/2},{x:-r/2,y:i/2}];return createPolygon(e,t+r/2,n+i/2,vtx,o,u)}else{var a=cos(s),f=sin(s);var l=r/2,c=i/2;vtx=[{x:-l*a+c*f,y:-l*f-c*a},{x:l*a+c*f,y:l*f-c*a},{x:l*a-c*f,y:l*f+c*a},{x:-l*a-c*f,y:-l*f+c*a}];return createPolygon(e,t+r/2,n+i/2,vtx,o,u)}}function initWalls(e,t,n,r){var i=createBox(e,0,-r/2,t,r,0,true);i.SetUserData("floor");var s=createBox(e,-r/2,0,r,n,0,true);s.SetUserData("l_wall");var o=createBox(e,t-r/2,0,r,n,0,true);o.SetUserData("r_wall");return{floor:i,l_wall:s,r_wall:o}}function translateBody(e,t){Object.keys(body).forEach(function(n){var r=body[n].GetPosition();body[n].SetType(b2Body.b2_staticBody);body[n].SynchronizeTransform(new b2Vec2(r.x+e,r.y+t),0);body[n].SetType(b2Body.b2_dynamicBody)})}function xToWorld(e){return worldWidth*e/cWidth}function yToWorld(e){return worldHeight*(cHeight-e)/cHeight}function xToCanvas(e){return cWidth*e/worldWidth}function yToCanvas(e){return cHeight*(worldHeight-e)/worldHeight}function toCanvas(e,t){return[xToCanvas(e),yToCanvas(t)]}function hasContact(e,t){cList=e.GetContactList();while(cList!=null){if(cList.other==t){return true}cList=cList.next}return false}function kneeAtLimit(e){if(e.GetJointAngle()<kneeLimits[0]+.2){return-1}else if(e.GetJointAngle()>kneeLimits[1]-.2){return 1}else{return 0}}function hipAtLimit(e){if(e.GetJointAngle()<hipLimits[0]+.3){return-1}else if(e.GetJointAngle()>hipLimits[1]-.3){return 1}else{return 0}}function handleKeyPressed(e){switch(e){case 1:handleQPressed();break;case 2:handleWPressed();break;case 4:handleOPressed();break;case 8:handlePPressed();break}}function handleQPressed(){if(maintainLeftHipStability){maintainLeftHipStability=false}joint.l_hip.SetMotorSpeed(l_hip_rotate_speed);joint.r_hip.SetMotorSpeed(-r_hip_rotate_speed)}function handleWPressed(){if(maintainRightHipStability){maintainRightHipStability=false}joint.l_hip.SetMotorSpeed(-l_hip_rotate_speed);joint.r_hip.SetMotorSpeed(r_hip_rotate_speed)}function handleOPressed(){if(maintainLeftKneeStability||maintainRightKneeStability){maintainLeftKneeStability=false;maintainRightKneeStability=false}joint.l_knee.SetMotorSpeed(l_knee_rotate_speed);joint.r_knee.SetMotorSpeed(-r_knee_rotate_speed)}function handlePPressed(){if(maintainRightKneeStability||maintainLeftKneeStability){maintainLeftKneeStability=false;maintainRightKneeStability=false}joint.r_knee.SetMotorSpeed(r_knee_rotate_speed);joint.l_knee.SetMotorSpeed(-l_knee_rotate_speed)}function handleKeyReleased(e){switch(e){case 1:handleQReleased();break;case 2:handleWReleased();break;case 4:handleOReleased();break;case 8:handlePReleased();break}}function handleQReleased(){maintainLeftHipStability=true;joint.l_hip.SetMotorSpeed(0);joint.r_hip.SetMotorSpeed(0);l_hipAngle=joint.l_hip.GetJointAngle();r_hipAngle=joint.r_hip.GetJointAngle()}function handleWReleased(){maintainRightHipStability=true;joint.r_hip.SetMotorSpeed(0);joint.l_hip.SetMotorSpeed(0);r_hipAngle=joint.r_hip.GetJointAngle();l_hipAngle=joint.l_hip.GetJointAngle()}function handleOReleased(){maintainLeftKneeStability=true;maintainRightKneeStability=true;joint.l_knee.SetMotorSpeed(0);joint.r_knee.SetMotorSpeed(0);l_kneeAngle=joint.l_knee.GetJointAngle();r_kneeAngle=joint.r_knee.GetJointAngle()}function handlePReleased(){maintainLeftKneeStability=true;maintainRightKneeStability=true;joint.r_knee.SetMotorSpeed(0);joint.l_knee.SetMotorSpeed(0);l_kneeAngle=joint.l_knee.GetJointAngle();r_kneeAngle=joint.r_knee.GetJointAngle()}function updateKeyState(e){var t=1;for(var n=0;n<4;n++){var r=(e&t)-(keyState&t);if(r==-t){handleKeyReleased(t)}t*=2}keyState=e}function shiftBodyX(e,t){Object.keys(body).forEach(function(n){var r=body[n];var i=new b2Vec2(r.GetWorldCenter().x+e,r.GetWorldCenter().y+t);r.SetPosition(i)})}function lockRevoluteJoint(e,t){t=t==undefined?Infinity:t;e.SetMaxMotorTorque(t);e.SetMotorSpeed(0);e.EnableMotor(true)}function resetRunner(){if(init){Object.keys(body).forEach(function(e){world.DestroyBody(body[e])});Object.keys(joint).forEach(function(e){world.DestroyJoint(joint[e])});recordedMoves=[{key:"none",type:"initialization",time:0}];elapsedTime=0;totalDistTraveled=0;totalStepsTraveled=0}maintainLeftHipStability=true;maintainLeftKneeStability=true;maintainRightHipStability=true;maintainRightKneeStability=true;joint={};body={};l_kneeAngle=.175,r_kneeAngle=.175;l_hipAngle=-.25,r_hipAngle=.5;init=true;var e=createBall(world,250,160,25,false,.1);var t=createBox(world,202,126,40,8,0,false,.1);var n=createBox(world,248,44,10,40,PI/6,false,10);var r=createBox(world,248,16,10,40,-PI/6,false,10);var i=createBox(world,234,68,32,70,0,false,5);var s=createBox(world,258,126,40,8,0,false,.1);var o=createBox(world,248,44,10,40,PI/6,false,10);var u=createBox(world,248,16,10,40,-PI/6,false,10);curVelX=0;body.head=e;body.torso=i;body.l_arm=t;body.r_arm=s;body.ll_leg=r;body.ul_leg=n;body.lr_leg=u;body.ur_leg=o;e.SetUserData("head");i.SetUserData("torso");t.SetUserData("l_arm");s.SetUserData("r_arm");r.SetUserData("ll_leg");n.SetUserData("ul_leg");u.SetUserData("lr_leg");o.SetUserData("ur_leg");var a=new b2WeldJointDef;var f=e.GetWorldCenter();f.y=f.y-20;a.Initialize(e,i,f);var l=world.CreateJoint(a);var c=new b2RevoluteJointDef;var h=t.GetWorldCenter();h.x=h.x+15;c.Initialize(t,i,h);var p=world.CreateJoint(c);var d=new b2RevoluteJointDef;var v=s.GetWorldCenter();v.x=v.x-15;d.Initialize(s,i,v);var m=world.CreateJoint(d);var g=new b2RevoluteJointDef;var y=n.GetWorldCenter();y.x=y.x+8.25;y.y=y.y-14.3;g.Initialize(n,r,y);var b=world.CreateJoint(g);var w=new b2RevoluteJointDef;var E=o.GetWorldCenter();E.x=E.x+8.25;E.y=E.y-14.3;w.Initialize(o,u,E);var S=world.CreateJoint(w);var x=new b2RevoluteJointDef;var T=n.GetWorldCenter();T.x=T.x-12;T.y=T.y+26;x.Initialize(i,n,T);var N=world.CreateJoint(x);var C=new b2RevoluteJointDef;var k=o.GetWorldCenter();k.x=k.x-12;k.y=k.y+26;C.Initialize(i,o,k);var L=world.CreateJoint(C);joint.neck=l;joint.l_arm=p;joint.r_arm=m;joint.l_hip=N;joint.r_hip=L;joint.l_knee=b;joint.r_knee=S;setFilterGroup([t,s,environment.floor],-1);setFilterGroup([i,n,o,r,u],-2);lockRevoluteJoint(b);lockRevoluteJoint(S);lockRevoluteJoint(N);lockRevoluteJoint(L);lockRevoluteJoint(p,8e3);lockRevoluteJoint(m,8e3);setInterval(function(){if(!mainLoopPaused){if(maintainLeftHipStability){var e=N.GetJointAngle();N.SetMotorSpeed(2*(l_hipAngle-e))}if(maintainRightHipStability){e=L.GetJointAngle();L.SetMotorSpeed(2*(r_hipAngle-e))}if(maintainLeftKneeStability){var e=b.GetJointAngle();b.SetMotorSpeed(2*(l_kneeAngle-e))}if(maintainRightKneeStability){e=S.GetJointAngle();S.SetMotorSpeed(2*(r_kneeAngle-e))}}},100);N.EnableLimit(true);N.SetLimits(hipLimits[0],hipLimits[1]);L.EnableLimit(true);L.SetLimits(hipLimits[0],hipLimits[1]);b.EnableLimit(true);b.SetLimits(kneeLimits[0],kneeLimits[1]);S.EnableLimit(true);S.SetLimits(kneeLimits[0],kneeLimits[1]);curX=getHipBaseX()}function setFilterGroup(e,t){e.forEach(function(e){var n=e.GetFixtureList();var r=n.GetFilterData();r.groupIndex=t;n.SetFilterData(r)})}function getHipBaseX(){var e=body.torso.GetAngle();var t=body.torso.GetPosition().x;return t-35*sin(e)}function handleInput(){switch(keyState){case 1:handleQPressed();break;case 2:handleWPressed();break;case 3:handleQPressed();handleWPressed();break;case 4:handleOPressed();break;case 5:handleQPressed();handleOPressed();break;case 6:handleWPressed();handleOPressed();break;case 7:handleQPressed();handleWPressed();handleOPressed();break;case 8:handlePPressed();break;case 9:handleQPressed();handlePPressed();break;case 10:handleWPressed();handlePPressed();break;case 11:handleQPressed();handleWPressed();handlePPressed();break;case 12:handleOPressed();handlePPressed();break;case 13:handleQPressed();handleOPressed();handlePPressed();break;case 14:handleWPressed();handleOPressed();handlePPressed();break;case 15:handleQPressed();handleWPressed();handleOPressed();handlePPressed();break}}function getFootY(e){return e.GetUserData()=="ll_leg"?getLeftFootY():getRightFootY()}function getLeftFootY(e){e=e==undefined?body:e;return e.ll_leg.GetPosition().y-20*cos(e.ll_leg.GetAngle())}function getRightFootY(e){e=e==undefined?body:e;return e.lr_leg.GetPosition().y-20*cos(e.lr_leg.GetAngle())}function draw(e){var t=e.GetPosition();var n=e.GetFixtureList();if(n!==null){var r=n.GetShape();var i=r.GetType();if(i==b2Shape.e_circleShape){ctx.beginPath();ctx.arc(xToCanvas(t.x),yToCanvas(t.y),40,0,2*PI,false);ctx.fillStyle="#FFF3C3";ctx.fill();ctx.lineWidth=5;ctx.strokeStyle="#003300";ctx.stroke()}else{ctx.beginPath();var s=r.m_vertices;var o=e.GetAngle();var u=sin(o),a=cos(o);var f=s[0].x*a-s[0].y*u,l=s[0].x*u+s[0].y*a;ctx.moveTo(xToCanvas(t.x+f),yToCanvas(t.y+l));for(var c=1;c<s.length;c++){ctx.lineTo(xToCanvas(t.x+(s[c].x*a-s[c].y*u)),yToCanvas(t.y+(s[c].x*u+s[c].y*a)))}ctx.lineTo(xToCanvas(t.x+f),yToCanvas(t.y+l));ctx.fillStyle="#FFF3C3";ctx.fill();ctx.lineWidth=5;ctx.strokeStyle="#003300";ctx.stroke()}}}function mainLoop(){if(!mainLoopPaused){ctx.clearRect(0,0,cWidth,cHeight);var e=world.GetBodyList();if(drawWorld){while(e.GetNext()!==null){draw(e);e=e.GetNext()}}world.Step(freq,2,2);handleInput();elapsedTime+=freq;if(requestTeleport){requestTeleport=false;lastStepX=0;shiftBodyX(-300,0);curX=getHipBaseX()}var t=getHipBaseX();var n=(t-curX)/25;totalDistTraveled+=n;farthestDistTraveled=max(farthestDistTraveled,totalDistTraveled);curX=t;prevVelX=curVelX;curVelX=n/freq;if(n>0){scoreCheckpointDist-=n;if(scoreCheckpointDist<=0){if(aimode){notifyDistTraveled()}scoreCheckpointDist=2;scorePenaltyDist=2}}else{scorePenaltyDist+=n;if(scorePenaltyDist<=0){if(aimode){notifyBackwardsTraveled()}scoreCheckpointDist=2;scorePenaltyDist=2}}prevHipJointAngle=hipJointAngle;hipJointAngle=joint.r_hip.GetJointAngle()-joint.l_hip.GetJointAngle();if(!step_phase[0]){if(hipJointAngle<-1.5&&hasContact(body.lr_leg,environment.floor)){lastStepX=getHipBaseX();stepBeginAngle=hipJointAngle;stepBackLeg=body.lr_leg;stepBackJoint=joint.r_knee;stepForwardLeg=body.ll_leg;step_phase[0]=true;if(aimode){notifyStepBegun()}if(recordingSteps){startRecording();console.log("(+) WALK INITIATED")}}else if(hipJointAngle>1.5&&hasContact(body.ll_leg,environment.floor)){lastStepX=getHipBaseX();stepBeginAngle=hipJointAngle;stepBackLeg=body.ll_leg;stepBackJoint=joint.l_knee;stepForwardLeg=body.lr_leg;step_phase[0]=true;if(aimode){notifyStepBegun()}if(recordingSteps){startRecording();console.log("(+) WALK INITIATED")}}}if(step_phase[0]&&!step_phase[1]&&hipJointAngle*prevHipJointAngle<0){step_phase[1]=true;if(aimode){notifyHalfStep()}if(recordingSteps){console.log("(+) HALF STEP DETECTED")}}if(step_phase[0]&&step_phase[1]){if(hipJointAngle*stepBeginAngle<-2.5&&getFootY(stepBackLeg)<20&&abs(body.torso.GetAngle()+.25)<.4){var r=getHipBaseX();var i=r-lastStepX;if(recordingSteps){endRecording(i>0,i)}totalStepsTraveled++;stepBeginAngle=hipJointAngle;stepBackLeg=stepBackLeg==body.ll_leg?body.lr_leg:body.ll_leg;stepBackJoint=stepBackLeg==joint.l_knee?joint.r_knee:joint.l_knee;step_phase[0]=true;step_phase[1]=false;if(aimode){notifyStepComplete(i)}if(recordingSteps){console.log("(+) STEP DETECTED: DISTANCE OF "+i);startRecording()}stepDistances.push(i);lastStepX=r%500}}ctx.font="20pt Calibri";ctx.fillStyle="black";ctx.fillText("Best Distance: "+round(farthestDistTraveled)+" m",100,50);ctx.fillText("Total Distance: "+round(totalDistTraveled)+" m",100,100);ctx.fillText("Keystate: "+action_strings[keyState],100,150);if(aimode&&showAIDetails){ctx.fillText("Iterations: "+iterations,100,200)}if(body.head.GetPosition().y<75&&aimode){if(!fallen){notifyFall(totalStepsTraveled)}}if(requestReset){if(aimode){distData.push({t:iterations,dist:totalDistTraveled,steps:totalStepsTraveled})}if(recordingSteps){endRecording(false);console.log("(-) YOU DIED.")}step_phase=[false,false];stepBeginAngle=NaN;stepBackLeg=undefined;stepBackJoint=undefined;stepForwardLeg=undefined;lastStepX=0;resetRunner();requestReset=false;respawning=true;deathCount++;scoreCheckpointDist=2;scorePenaltyDist=2;setTimeout(function(){respawning=false;activateWalkDelay()},1e3)}}}function activateWalkDelay(){walkDelay=true;setTimeout(function(){walkDelay=false},1e3)}function center_of_mass(e){var t=0,n=0,r=0;for(var i in e){var s=e[i];var o=s.GetMass();var u=s.GetPosition();r+=o;t+=o*u.x;n+=o*u.y}t/=r;n/=r;return{x:t,y:n}}function roundToTenThousandth(e){return round(e*1e4)/1e4}function roundToHundredth(e){return round(e*100)/100}function roundToTenth(e){return round(e*10)/10}var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2Shape=Box2D.Collision.Shapes.b2Shape,b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef,b2WeldJointDef=Box2D.Dynamics.Joints.b2WeldJointDef,b2FilterData=Box2D.Dynamics.b2FilterData,b2ContactListener=Box2D.Dynamics.b2ContactListener;var canv=document.getElementById("canvas");var ctx=canv.getContext("2d");var cWidth=canv.width=1054;var cHeight=canv.height=632;var mainLoopPaused=false;min=Math.min;max=Math.max;round=Math.round;floor=Math.floor;random=Math.random;cos=Math.cos;sin=Math.sin;abs=Math.abs;pow=Math.pow;sqrt=Math.sqrt;PI=Math.PI;var timestep=60;var freq=1/timestep;var gravity=new b2Vec2(0,-75);var world=new b2World(gravity,true);var worldWidth=500;var worldHeight=300;var environment=initWalls(world,worldWidth,worldHeight,24);var fakeWorld=undefined;var distData=[];var walkData=[];var stepData=[];var recordLoopId=undefined;var aimode=false;var showAIDetails=false;var drawWorld=true;var recordingSteps=false;var init=false;var keyMasks={q:1,w:2,o:4,p:8};var keyState=0;var keyEventCodes={80:"p",79:"o",87:"w",81:"q",32:" "};var action_strings={0:" ",1:"Q",2:"W",4:"O",6:"WO",8:"P",9:"QP"};var maintainLeftHipStability=true;var maintainLeftKneeStability=true;var maintainRightHipStability=true;var maintainRightKneeStability=true;var joint={};var body={};var l_kneeAngle=.175,r_kneeAngle=.175;var l_hipAngle=-.25,r_hipAngle=.5;var l_hip_rotate_speed=3;var r_hip_rotate_speed=3;var l_knee_rotate_speed=3;var r_knee_rotate_speed=3;var hipLimits=[-1,1];var kneeLimits=[-.25,1];var elapsedTime=0;var totalDistTraveled=0;var farthestDistTraveled=0;var curX=0;var requestTeleport=false;var curVelX=0;var prevVelX=0;var autoReset=true;var requestReset=false;var respawning=false;var walkDelay=false;var legalKeyStates=[true,true,true,false,true,false,true,false,true,true,false,false,false,false,false,false];var hipJointAngle=0;var prevHipJointAngle=0;var step_phase=[false,false];var stepBeginAngle=NaN;var stepBackLeg=undefined;var stepForwardLeg=undefined;var stepBackJoint=undefined;var totalStepsTraveled=0;var lastStepX=0;var stepDistances=[];var deathCount=0;var scoreCheckpointDist=2;var scorePenaltyDist=2;document.onkeydown=function(e){var t=keyEventCodes[e.keyCode];if(t==" "){if(aimode){advance_step()}else if(elapsedTime>1.5){resetRunner()}}var n=keyMasks[t];if(n!==undefined&&legalKeyStates[keyState|n]){keyState=keyState|n}};document.onkeyup=function(e){var t=keyEventCodes[e.keyCode];var n=keyMasks[t];if(n!==undefined&&legalKeyStates[keyState&~n]){keyState=keyState&~n;handleKeyReleased(n)}};var listener=new b2ContactListener;listener.BeginContact=function(e){};listener.PreSolve=function(e,t){body_A=e.GetFixtureA().GetBody();body_B=e.GetFixtureB().GetBody();if(body_A==environment.r_wall||body_B==environment.r_wall){requestTeleport=true}else if(autoReset){if(body_A==environment.floor){if(body_B!==body.ll_leg&&body_B!==body.ul_leg&&body_B!==body.lr_leg&&body_B!==body.ur_leg){requestReset=true}}else if(body_B==environment.floor){if(body_A!==body.ll_leg&&body_A!==body.ul_leg&&body_A!==body.lr_leg&&body_A!==body.ur_leg){requestReset=true}}}};world.SetContactListener(listener);setInterval(mainLoop,1e3*freq);resetRunner()